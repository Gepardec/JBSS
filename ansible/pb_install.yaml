---

- hosts: localhost 
  vars:
    local_home: "{{ lookup('env','HOME') }}"
    jboss_home: "{{local_home}}/jboss/anstest"
    port_offset: 100
    jboss_version: jboss-eap-7.0.0
    download_zip: "{{local_home}}/Downloads/{{jboss_version}}.zip"
  tasks:
    - name: Stop JBoss in case it exists
      wildfly_configure:
        jboss_home: "{{jboss_home}}"
        jboss_version: "{{jboss_version}}"
        jboss_port_offset: "{{port_offset}}"
        stop: true
      ignore_errors: yes
    - name: delete jboss home
      file: path="{{jboss_home}}" state=absent
    - name: Unzip JBoss Package
      wildfly_install:
        zip: "{{download_zip}}"
        jboss_home: "{{jboss_home}}"
    - name: Start JBoss
      wildfly_configure:
        jboss_home: "{{jboss_home}}"
        jboss_version: "{{jboss_version}}"
        jboss_port_offset: "{{port_offset}}"
        restart: true
    - name: create tempfile
      command: mktemp -d
      register: temp_install
    - debug:
        var: temp_install.stdout
    - name: copy configuration
      copy:
        src: config
        dest: "{{temp_install.stdout}}"
    - name: Configure JBoss
      wildfly_configure:
        jboss_home: "{{jboss_home}}"
        jboss_version: "{{jboss_version}}"
        jboss_port_offset: "{{port_offset}}"
        dir: "{{temp_install.stdout}}/config"
